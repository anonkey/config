#!/bin/zsh
# **************************************************************************** #
#                                                                              #
#                                                         :::      ::::::::    #
#    makegen.sh                                         :+:      :+:    :+:    #
#                                                     +:+ +:+         +:+      #
#    By: tseguier <marvin@42.fr>                    +#+  +:+       +#+         #
#                                                 +#+#+#+#+#+   +#+            #
#    Created: 2014/11/22 19:42:08 by tseguier          #+#    #+#              #
#    Updated: 2014/11/22 19:42:08 by tseguier         ###   ########.fr        #
#                                                                              #
# **************************************************************************** #


if [[ $# -gt 0 ]]
then
	if [[ $# -gt 1 ]]
	then
		name=$2;
	elif [[ $1 != "-L" ]]
	then
		name=$1;
		shift;
	else
		name=`basename $PWD`
	fi
else
	name=`basename $PWD`
fi
if [ $# -eq 0 ]
then
	(echo -n '
CC = clang
CFLAGS = -Wall -Wextra -Werror
ifeq ($(DEBUG), 1)
	CFLAGS += -ggdb3
endif
INCDIRS = '
find include -maxdepth 1 -type d | sed "s/ $//g"
echo '
INCFLAGS = $(foreach T, $(INCDIRS), -I ./$(T))
NAME = '"$name";
	if [[ -d lib ]]
	then
		echo -n 'LIBS = '
		ls lib | grep lib | sed "s/^lib//g"| tr -s "\n" "  " | sed "s/ $//g" 
		echo '
INCFLAGS += $(foreach T, $(LIBS), -I ./lib/lib$(T)/include)
LIBDIRS = $(foreach T, $(LIBS), ./lib/lib$(T))
LIBDIRS_FLAGS = $(foreach T, $(LIBDIRS), -L $(T))
LIBFLAGS = $(foreach T, $(LIBS), -l$(T))
LIBDEPS = $(foreach T, $(LIBS), lib/lib$(T)/lib$(T).a)'
	fi
	echo -n '
SRC = '
	ls src/**/*.c |  sed "s/$/ \\\\/g"
	echo '
OBJ = $(SRC:.c=.o)'
	if [[ -d lib ]]
	then
		echo '
all: make_  $(NAME)

make_:
	$(foreach T, $(LIBDIRS), make -C $(T))

fclean_:
	$(foreach T, $(LIBDIRS), make -C $(T) fclean)

$(NAME): $(OBJ) $(LIBDEPS)
	$(CC) $(CFLAGS) $(INCFLAGS) $(LIBDIRS_FLAGS) $(LIBFLAGS) $(OBJ) -o $(NAME)

%.o: %.c
	$(CC) $(INCFLAGS) $(CFLAGS) -c $< -o $@

clean:
	rm -rf $(OBJ)

fclean: fclean_ clean
	rm -rf $(NAME)

re: fclean_ fclean all

.PHONY: make_ fclean_ clean fclean all re'
	else
		echo '
all:  $(NAME)

$(NAME): $(OBJ)
	$(CC) $(CFLAGS) $(INCFLAGS) $(OBJ) -o $(NAME)

%.o: %.c
	$(CC) $(INCFLAGS) $(CFLAGS) -c $< -o $@

clean:
	rm -rf $(OBJ)

fclean: clean
	rm -rf $(NAME)

re: fclean all

.PHONY: clean fclean all re'
	fi
	) >| Makefile
else
	(
	echo -n '
CC = clang
CFLAGS = -Wall -Wextra -Werror
ifeq ($(DEBUG), 1)
	CFLAGS += -ggdb3
endif
LDFLAGS=rc
INCDIRS = '
	find include -maxdepth 1 -type d | sed "s/ $//g"
	echo -n '
INCFLAGS = $(foreach T, $(INCDIRS), -I ./$(T))
NAME = ';
	echo "$name.a";
	if [[ -d lib ]]
	then
		echo -n 'LIBS = '
		ls lib | grep lib | tr -s "\n" "  " | sed "s/ $//g"
		echo '
INCFLAGS += $(foreach T, $(LIBS), -I ./lib/lib$(T)/include)
LIBDIRS = $(foreach T, $(LIBS), ./lib/lib$(T))
LIBDIRS_FLAGS = $(foreach T, $(LIBDIRS), -L $(T))
LIBFLAGS = $(foreach T, $(LIBS), -l$(T))
LIBDEPS = $(foreach T, $(LIBS), lib/lib$(T)/lib$(T).a)'
	fi
	echo -n '
SRC = '
	ls src/**/*.c |  sed "s/$/ \\\\/g"
	echo '
OBJ = $(SRC:.c=.o)'
	if [[ -d lib ]]
	then
		echo '
all: make_  $(NAME)

make_:
	$(foreach T, $(LIBDIRS), make -C $(T))

fclean_:
	$(foreach T, $(LIBDIRS), make -C $(T) fclean)

$(NAME): $(OBJ) $(LIBDEPS)
	ar $(LDFLAGS) $(NAME) $(OBJ)
	ranlib $(NAME)

%.o: %.c
	$(CC) $(INCFLAGS) $(CFLAGS) -c $< -o $@

clean:
	rm -rf $(OBJ)

fclean: fclean_ clean
	rm -rf $(NAME) $(NAME).dSYM

re: fclean_ fclean all

.PHONY: make_ fclean_ clean fclean all re'
	else
		echo '
all:  $(NAME)

$(NAME): $(OBJ) $(LIBDEPS)
	ar $(LDFLAGS) $(NAME) $(OBJ)
	ranlib $(NAME)

%.o: %.c
	$(CC) $(INCFLAGS) $(CFLAGS) -c $< -o $@

clean:
	rm -rf $(OBJ)

fclean: clean
	rm -rf $(NAME)

re: fclean all

.PHONY: clean fclean all re'
	fi
	) >| Makefile
fi
